---
:src: mpich2-1.4.1p1.tar.gz
:type: mpi
:version: 1.4.1p1
:compilers:
  gcc:
    :configure_prefix:
    :configure_flags: '--with-pm=hydra:mpd:gforker --enable-shared'
  intel:
    :configure_prefix: "CC='icc -i-dynamic' CXX='icpc -i-dynamic' FC='ifort -i-dynamic' F90=''"
    :configure_flags: '--with-pm=hydra:mpd:gforker --enable-shared --enabled-sharedlibs=gcc'
:sources:
  - examples.sge.mpich2.template
  - examples.mpd.conf
  - examples.sge.mpich2_mpd.template
:compile: |
  <%= compiler[:configure_prefix] %> ./configure --prefix=<%= dest_dir %> <%= compiler[:configure_flags] %> <%= redirect(:configure) %>
  make <%= redirect(:make) %>
:install: |
  <% if @mode == :spec %>
  # The real install
  %{__make} install PREFIX=<%= dest_dir %>

  # sed out the RPM_BUILD_ROOT from various files
  # NB. the -I parameter to grep ensures we don't clobber binary files
  # (-I is treat binary files as unmatched)
  grep -Ilr $RPM_BUILD_ROOT $RPM_BUILD_ROOT | xargs -L1 sed -i "s|$RPM_BUILD_ROOT||g"
  <% else %>
  make install <%= redirect(:install) %>
  <% end %>

  install -D -m 644 <%= source('examples.sge.mpich2.template') %> <%= dest_dir %>/examples/sge/mpich2.template
  install -D -m 644 <%= source('examples.sge.mpich2_mpd.template') %> <%= dest_dir %>/examples/sge/mpich2_mpd.template
  install -D -m 644 <%= source('examples.mpd.conf') %> <%= dest_dir %>/examples/mpd.conf
:module: |
  #%Module1.0#####################################################################
  ##
  ## mpich2 module file
  ##
  ################################################################################
  proc ModulesHelp { } {
          global version

          puts stderr "\tAdds `mpich2-$version' to your PATH environment variable and necessary libraries"
  }

  set     version <%= version %>

  module-whatis   "loads the necessary `mpich2-$version' library paths"

  set MPI_DIR <%= dest_dir %>

  setenv           MPI_HOME $MPI_DIR
  setenv           MPICH_USE_SHLIB   yes
  setenv           P4_GLOBMEMSIZE    67108864

  prepend-path PATH $MPI_DIR/bin/
  prepend-path LD_LIBRARY_PATH $MPI_DIR/lib/
  prepend-path LD_LIBRARY_PATH $MPI_DIR/lib/shared/
  prepend-path MANPATH $MPI_DIR/share/man/
