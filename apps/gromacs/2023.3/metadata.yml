---
:schema: 1
:license: GPL
:summary: Perform molecular dynamics; simulate the Newtonian equations of motion for systems with hundreds to millions of particles
:url: http://www.gromacs.org/
:description: |
  GROMACS is a versatile package to perform molecular dynamics,
  i.e. simulate the Newtonian equations of motion for systems with
  hundreds to millions of particles.

  It is primarily designed for biochemical molecules like proteins,
  lipids and nucleic acids that have a lot of complicated bonded
  interactions, but since GROMACS is extremely fast at calculating the
  nonbonded interactions (that usually dominate simulations) many groups
  are also using it for research on non-biological systems,
  e.g. polymers.
:type: apps
:group: Chemistry
:requirements:
  :tool: apps/cmake >= 3.16.3
  :runtime:
    - mpi/openmpi
    - apps/python3 >= 3.7.0
  :build:
    - mpi/openmpi
    - apps/python3 >= 3.7.0
:variants:
  default:
    :description: "Builds both double and single precision GROMACS into the same application location."
    :default_precision: float
    :requirements:
      :build:
        - libs/fftw3_float
        - libs/fftw3_double
        - libs/openblas
      :runtime:
        - libs/fftw3_float
        - libs/fftw3_double
  float:
    :description: "Builds only a single precision GROMACS."
    :default_precision: float
    :requirements:
      :build:
        - libs/fftw3_float
        - libs/openblas
      :runtime:
        - libs/fftw3_float
  double:
    :description: "Builds only a double precision GROMACS."
    :default_precision: double
    :default_precision_cmake_flags: -DGMX_DOUBLE=ON
    :requirements:
      :build:
        - libs/fftw3_double
        - libs/openblas
      :runtime:
        - libs/fftw3_double
  cuda:
    :description: "Builds a single precision CUDA accelerated GROMACS."
    :default_precision: float
    :default_precision_cmake_flags: -DGMX_GPU=CUDA -DCUDA_TOOLKIT_ROOT_DIR="$CUDA_DIR"
    :requirements:
      :build:
        - libs/fftw3_float
        - libs/nvidia-cuda >= 11
        - libs/openblas
      :runtime:
        - libs/fftw3_float
        - libs/nvidia-cuda >= 11
:changelog: |
  * Thu Nov  2 2023 - Rob Brown <rob.brown@alces-flight.com>
    - Updated to latest v2023.3 version
  * Fri Jun  9 2023 - Rob Brown <rob.brown@alces-flight.com>
    - Updated to latest v2023.1 version
    - Updated to work with OpenBLAS
  * Fri Feb  3 2023 - Rob Brown <rob.brown@alces-flight.com>
    - Updated to latest v2022.5 version
  * Mon Jul 20 2022 - Rob Brown <rob.brown@alces-flight.com>
    - Updated to latest v2022.2 version
  * Mon Mar 14 2022 - Rob Brown <rob.brown@alces-flight.com>
    - Updated to latest v2022 version
  * Wed Sep 18 2019 - Rob Brown <rob.brown@alces-flight.com>
    - Updated to latest v2019.3 version
  * Thu Dec 6  2018 - Ruan G. Ellis <ruan.ellis@alces-software.com>
    - Updated to latest v2018.4 version
  * Tue Sep 20 2016 Andrew Provis <andrew.provis@alces-software.com>
    - Updated example templates to Clusterware literal scripts
  * Fri Jun 17 2016 - Mark J. Titorenko <mark.titorenko@alces-software.com>
    - Add FFTW3 runtime dependencies
  * Fri May 27 2016 - Ruan G. Ellis <ruan.ellis@alces-software.com>
    - Added distro dependencies for EL
  * Wed Mar  5 2014 James Donohue <james.donohue@alces-software.com>
    - Added example script
  * Thu Jan 23 2014 - James Donohue <james.donohue@alces-software.com>
    - Bumped to latest version, v4.6.5
  * Fri May 10 2013 - Mark J. Titorenko <mark.titorenko@alces-software.com>
    - Bumped to latest version, v4.6.1
  * Tue Feb  4 2013 - Mark J. Titorenko <mark.titorenko@alces-software.com>
    - Bumped to latest version, v4.6
  * Thu Dec  6 2012 - Mark J. Titorenko <mark.titorenko@alces-software.com>
    - Add variant logic to provide builds for double precision, single
      precision or both (default).
  * Mon Mar 19 2012 - Mark J. Titorenko <mark.titorenko@alces-software.com>
    - First created
:src: gromacs-2023.3.tar.gz
:src_dir: gromacs-2023.3
:version: '2023.3'
:compilers:
  gcc:
    :float_configure_prefix: CMAKE_PREFIX_PATH="$FFTW3_FLOATDIR"
    :double_configure_prefix: CMAKE_PREFIX_PATH="$FFTW3_DOUBLEDIR"
    :fft: fftw3
  intel:
    :float_configure_prefix: CMAKE_PREFIX_PATH="$FFTW3_FLOATDIR"
    :double_configure_prefix: CMAKE_PREFIX_PATH="$FFTW3_DOUBLEDIR"
    :fft: fftw3
:dependencies:
  :build:
    el:
      - gcc-c++
:compile: |
  cp -r <%= src_dir %> <%= src_dir %>.mpi
  <% if variant_name == 'default' %>
  cp -r <%= src_dir %> <%= src_dir %>.double
  cp -r <%= src_dir %> <%= src_dir %>.double_mpi
  <% end %>

  mkdir build
  cd build
  <%= compiler[:"#{variant[:default_precision]}_configure_prefix"] %> cmake .. \
           -DGMX_EXTERNAL_BLAS=on -DGMX_EXTERNAL_LAPACK=on \
           -DGMX_LAPACK_USER=${OPENBLASLIB}/libopenblas.so \
           -DCMAKE_PREFIX_PATH=${OPENBLASLIB}/ \
           -DCMAKE_INSTALL_PREFIX=<%= dest_dir %> \
           -DGMX_BLAS_USER=${OPENBLASLIB}/libopenblas.so \
           <%= variant[:default_precision_cmake_flags] %> \
           <%= redirect(:cmake) %>
  make -j 4 <%= redirect(:make) %>

  cd "<%= src_dir %>.mpi"
  mkdir build
  cd build
  <%= compiler[:"#{variant[:default_precision]}_configure_prefix"] %> cmake .. \
           -DGMX_EXTERNAL_BLAS=on -DGMX_EXTERNAL_LAPACK=on \
           -DGMX_LAPACK_USER=${OPENBLASLIB}/libopenblas.so \
           -DGMX_MPI=ON \
           -DCMAKE_PREFIX_PATH=${OPENBLASLIB}/ \
           <%= variant[:default_precision_cmake_flags] %> \
           -DCMAKE_INSTALL_PREFIX=<%= dest_dir %> \
           -DGMX_BLAS_USER=${OPENBLASLIB}/libopenblas.so \
           <%= redirect(:cmake) %>
  make -j 4 <%= redirect(:make) %>

  <% if variant_name == 'default' %>
  cd "<%= src_dir %>.double"
  mkdir build
  cd build
  <%= compiler[:double_configure_prefix] %> cmake .. \
           -DGMX_EXTERNAL_BLAS=on -DGMX_EXTERNAL_LAPACK=on \
           -DGMX_LAPACK_USER=${OPENBLASLIB}/libopenblas.so \
           -DGMX_DOUBLE=ON \
           -DCMAKE_PREFIX_PATH=${OPENBLASLIB} \
           -DGMX_BLAS_USER=${OPENBLASLIB}/libopenblas.so \
           -DCMAKE_INSTALL_PREFIX=<%= dest_dir %> \
           <%= redirect(:cmake) %>
  make -j 4 <%= redirect(:make) %>

  cd "<%= src_dir %>.double_mpi"
  mkdir build
  cd build
  <%= compiler[:double_configure_prefix] %> cmake .. \
           -DGMX_EXTERNAL_BLAS=on -DGMX_EXTERNAL_LAPACK=on \
           -DGMX_LAPACK_USER=${OPENBLASLIB}/libopenblas.so \
           -DGMX_DOUBLE=ON \
           -DGMX_MPI=ON \
           -DCMAKE_PREFIX_PATH=${OPENBLASLIB}/ \
           -DGMX_BLAS_USER=${OPENBLASLIB}/libopenblas.so \
           -DCMAKE_INSTALL_PREFIX=<%= dest_dir %> \
           <%= redirect(:cmake) %>

  make -j 4 <%= redirect(:make) %>
  <% end %>
:install: |
  cd build
  make install <%= redirect(:install) %>
  cd <%= src_dir %>.mpi/build
  make install <%= redirect(:install) %>
  <% if variant_name == 'default' %>
  cd <%= src_dir %>.double/build
  make install <%= redirect(:install) %>
  cd <%= src_dir %>.double_mpi/build
  make install <%= redirect(:install) %>
  <% end %>
:module: |
  setenv ${appcaps}DIR ${appdir}
  setenv ${appcaps}BIN ${appdir}/bin

  prepend-path PATH ${appdir}/bin

  setenv GMXBIN ${appdir}/bin
  setenv GMXLDLIB ${appdir}/lib
  setenv GMXMAN ${appdir}/share/man
  setenv GMXDATA ${appdir}/share

  prepend-path PATH ${appdir}/bin
  prepend-path LD_LIBRARY_PATH ${appdir}/lib
  prepend-path PKG_CONFIG_PATH ${appdir}/lib/pkgconfig
  prepend-path MANPATH ${appdir}/share/man

  set completion_data ""
  if { [module-info shell] == "bash" } {
    set completion_data [exec bash -c "complete >/dev/null 2>&1 && echo source ${appdir}/bin/completion.bash"]
  } elseif { [module-info shell] == "tcsh" } {
    set completion_data [exec tcsh -c "complete >& /dev/null && echo source ${appdir}/bin/completion.csh"]
  } elseif { [module-info shell] == "zsh" } {
    set completion_data [exec zsh -c "compctl >& /dev/null && echo source ${appdir}/bin/completion.zsh"]
  }

  puts -nonewline "$completion_data;"
