---
:src: Nwchem-6.1-2012-Feb-10.tar.gz
:type: apps
:version: '6.1'
:compilers:
  gcc:
    :compiler_env: 'FC=gfortran CC=gcc'
:compile: |
  export LARGE_FILES=TRUE
  export USE_NOFSCHECK=TRUE
  export NWCHEM_TOP=`pwd`
  export NWCHEM_MODULES=all
  export NWCHEM_TARGET=LINUX64

  export BLASOPT="-L$BLASLIB"

  export USE_MPI=y
  export USE_MPIF=y
  export USE_MPIF4=y
  export MPI_LIB=$MPI_HOME/lib
  export MPI_INCLUDE=$MPI_HOME/include
  export LIBMPI="-L$MPI_LIB -lmpi -lopen-pal -lopen-rte -lmpi_f90 -lmpi_f77"

  cd src
  make nwchem_config <%= redirect(:configure) %>
  make <%= compiler[:compiler_env] %> <%= redirect(:make) %>
  cd ..
  cat > default.nwchemrc <<\EOT
  nwchem_basis_library <%= dest_dir %>/data/libraries/
  nwchem_nwpw_library <%= dest_dir %>/data/libraryps/
  ffield amber
  amber_1 <%= dest_dir %>/data/amber_s/
  amber_2 <%= dest_dir %>/data/amber_q/
  amber_3 <%= dest_dir %>/data/amber_x/
  amber_4 <%= dest_dir %>/data/amber_u/
  spce    <%= dest_dir %>/data/solvents/spce.rst
  charmm_s <%= dest_dir %>/data/charmm_s/
  charmm_x <%= dest_dir %>/data/charmm_x/
  EOT
  cat > README.alces.txt <<\EOT
  ----------------------------------------------------
  NWChem: notes for Alces Software HPC Stack for Linux
  ----------------------------------------------------

  As explained at http://www.nwchem-sw.org/index.php/Compiling_NWChem,
  each user will need a .nwchemrc file to point to default data
  files. A global rc file is provided in the data/ subdirectory and
  users should either create a symbolic link within their $HOME
  directory, or copy this file to allow them to change the defaults at
  their discretion.

  Therefore, users should issue one of the following commands prior to
  using NWChem:

    1. ln -s <%= dest_dir %>/data/default.nwchemrc $HOME/.nwchemrc
    2. cp <%= dest_dir %>/data/default.nwchemrc $HOME/.nwchemrc

  EOT
:install: |
  cp -r bin/LINUX64 <%= dest_dir %>/bin
  mkdir <%= dest_dir %>/doc
  cp LICENSE.TXT release* <%= dest_dir %>/doc
  cp -r lib/LINUX64 <%= dest_dir %>/lib
  cp -r QA contrib examples <%= dest_dir %>
  mkdir <%= dest_dir %>/data
  cp -r src/basis/libraries src/data/* src/nwpw/libraryps default.nwchemrc <%= dest_dir %>/data
  cp README.alces.txt <%= dest_dir %>
:module: |
  #%Module1.0#####################################################################
  ##
  ## Alces HPC Software Stack - Application module file
  ## Copyright (c) 2008-2012 Alces Software Ltd
  ##
  ################################################################################
  proc ModulesHelp { } {
          global app
          global version
          global appcaps
          global appdir

          puts stderr "Adds `$app-$version' to your environment variables"
          puts stderr ""
          puts stderr "##############"
          puts stderr "ENV after load"
          puts stderr "##############"
          puts stderr "${appcaps}DIR -> base path of application"
          puts stderr "${appcaps}BIN -> bin path of application"
          puts stderr "Adds ${appcaps}BIN to PATH"
          puts stderr ""
  }

  prereq mpi/<%= compiler_name %>/openmpi

  set     app      <%= package.name %>
  set     version  <%= version %>
  set     appcaps  <%= package.caps_name %>
  set     appdir   <%= dest_dir %>

  module-whatis   "loads the necessary `$app-$version' setup environment"

  setenv ${appcaps}DIR ${appdir}
  setenv ${appcaps}BIN ${appdir}/bin

  prepend-path PATH ${appdir}/bin

  prepend-path PATH ${appdir}/bin
  prepend-path LD_LIBRARY_PATH ${appdir}/lib

