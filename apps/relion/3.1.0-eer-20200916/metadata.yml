---
:schema: 1
:license: GPLv2+
:title: RELION
:summary: REgularised LIkelihood OptimisatioN
:url: http://www2.mrc-lmb.cam.ac.uk/relion/index.php/Main_Page
:description: |
  RELION (for REgularised LIkelihood OptimisatioN, pronounce rely-on)
  is a stand-alone computer program that employs an empirical Bayesian
  approach to refinement of (multiple) 3D reconstructions or 2D class
  averages in electron cryo-microscopy (cryo-EM). It is developed in
  the group of Sjors Scheres at the MRC Laboratory of Molecular
  Biology. Briefly, the ill-posed problem of 3D-reconstruction is
  regularised by incorporating prior knowledge: the fact that
  macromolecular structures are smooth, i.e. they have limited power
  in the Fourier domain. In the corresponding Bayesian framework, many
  parameters of a statistical model are learned from the data, which
  leads to objective and high-quality results without the need for
  user expertise. The underlying theory is given in Scheres (2012)
  JMB. A more detailed description of its implementation is given in
  Scheres (2012) JSB. If RELION is useful in your work, please cite at
  least one of these papers.
:group: Imaging
:changelog: |
  * Wed Oct  7 2020 - Rob Brown <rob.brown@alces-flight.com>
    - Updated to latest v3.1.0 post-release (with EER support) (2020-09-16)
  * Mon Aug 17 2020 - Rob Brown <rob.brown@alces-flight.com>
    - Updated to latest v3.1.0 release
  * Wed Jun 17 2020 - Rob Brown <rob.brown@alces-flight.com>
    - Updated to latest v3.1.0 beta version (2020-06-13)
  * Wed Oct 16 2019 - Rob Brown <rob.brown@alces-flight.com>
    - Updated to latest v3.1.0 beta version
  * Mon Mar 25 2019 - Rob Brown <rob.brown@alces-flight.com>
    - Updated to latest v3.0.3 version
  * Tue Jan 29 2019 - Mark J. Titorenko <mark.titorenko@alces-software.com>
    - Updated to latest v3.0.0 beta version
  * Wed Dec 20 2017 - Ruan G. Ellis <ruan.ellis@alces-software.com>
    - Updated to latest v2.1 stable version
  * Mon Feb 20 2017 - Ruan G. Ellis <ruan.ellis@alces-software.com>
    - Updated to latest v2.0.3 stable version
    - Added variants for CUDA support
  * Wed Oct  5 2016 - Ruan G. Ellis <ruan.ellis@alces-software.com>
    - Bumped to v2.0.20161005 Beta Version
  * Tue Feb  2 2016 - Mark J. Titorenko <mark.titorenko@alces-software.com>
    - First Created
:src: 3.1.0-eer-20200916.tar.gz
:src_dir: relion-6f0d9ead18117bd9f49865552f49daa541b762e8
:patches:
  - cmake-findfftw.patch
:type: apps
:version: 3.1.0-eer-20200916
:dependencies:
  :build:
    el:
      - libtiff-devel
  :runtime:
    el:
      - libtiff
:params:
  :cudaarch: "Specify CUDA Compute Architecture version - '37' for version 3.7 - If using the standard CPU version, pass 'default'"
  :moduleextras: "Specify absolute path to a file containing extra details to be included into the environment module or 'none' if no extra details are to be included"
:variants:
  default:
    :description: "Build for standard version"
    :requirements:
      :build:
        - libs/fftw3_double
        - libs/fftw3_float
        - libs/fltk
        - mpi/openmpi
        - apps/cmake
      :runtime:
        - libs/fftw3_double
        - libs/fftw3_float
        - libs/fltk
        - mpi/openmpi
  cudafloat:
    :description: "Build with Nvidia CUDA - Float"
    :requirements:
      :build:
        - libs/fftw3_double
        - libs/fftw3_float
        - libs/fltk
        - mpi/openmpi
        - apps/cmake
        - libs/nvidia-cuda
      :runtime:
        - libs/fftw3_double
        - libs/fftw3_float
        - libs/fltk
        - mpi/openmpi
        - libs/nvidia-cuda
  cudadp:
    :description: "Build with Nvidia CUDA - Double"
    :requirements:
      :build:
        - libs/fftw3_double
        - libs/fftw3_float
        - libs/fltk
        - mpi/openmpi
        - apps/cmake
        - libs/nvidia-cuda
      :runtime:
        - libs/fftw3_double
        - libs/fftw3_float
        - libs/fltk
        - mpi/openmpi
        - libs/nvidia-cuda
:compilers:
  gcc:
:compile: |
  <% if param(:moduleextras) != 'none' && !File.exists?(param(:moduleextras)) %>
  echo "Module extras file '<%= param(:moduleextras) %>' not found -- did you mean 'none'?"
  exit 1
  <% end %>
  export FFTW_HOME=${FFTW3_DOUBLEDIR}
  export FFTW_LIB=${FFTW3_DOUBLELIB}:${FFTW3_FLOATLIB}
  export FFTW_INCLUDE=${FFTW3_DOUBLEINCLUDE}:${FFTW3_FLOATINCLUDE}
  mkdir build && cd build
  <% if variant_name == 'default' %>
  cmake -DCMAKE_INSTALL_PREFIX=<%= dest_dir %> -DCUDA=OFF .. <%= redirect(:configure) %>
  <% elsif variant_name == 'cudafloat' %>
  cmake -DCMAKE_INSTALL_PREFIX=<%= dest_dir %> -DCUDA_ARCH=<%= param(:cudaarch) %> .. <%= redirect(:configure) %>
  <% else %>
  cmake -DCMAKE_INSTALL_PREFIX=<%= dest_dir %> -DCUDA_ARCH=<%= param(:cudaarch) %> -DDoublePrec_GPU=ON .. <%= redirect(:configure) %>
  <% end %>
  make <%= redirect(:compile) %>
:install: |
  cd build
  make install <%= redirect(:install) %>
:module: |
  setenv ${appcaps}DIR ${appdir}
  setenv ${appcaps}BIN ${appdir}/bin
  setenv ${appcaps}INCLUDE ${appdir}/include
  setenv ${appcaps}LIB ${appdir}/lib

  prepend-path PATH ${appdir}/bin
  prepend-path LD_LIBRARY_PATH ${appdir}/lib

  <%= File.read(param(:moduleextras)) %>
