---
:schema: 1
:title: TensorFlow
:license: Apache License 2.0
:summary: Computation using data flow graphs for scalable machine learning
:url: http://tensorflow.org
:description: |
  TensorFlow is an open source software library for numerical
  computation using data flow graphs. Nodes in the graph represent
  mathematical operations, while the graph edges represent the
  multidimensional data arrays (tensors) that flow between them. This
  flexible architecture lets you deploy computation to one or more
  CPUs or GPUs in a desktop, server, or mobile device without
  rewriting code. TensorFlow also includes TensorBoard, a data
  visualization toolkit.

  TensorFlow was originally developed by researchers and engineers
  working on the Google Brain team within Google's Machine
  Intelligence research organization for the purposes of conducting
  machine learning and deep neural networks research. The system is
  general enough to be applicable in a wide variety of other domains,
  as well.
:type: apps
:group: Machine Learning
:changelog: |
  * Mon Nov 21 2016 - Mark J. Titorenko <mark.titorenko@alces-software.com>
    - First created
  * Wed May 24 2017 - Ruan G. Ellis <ruan.ellis@alces-software.com>
    - Bumped to release v1.1.0 version
  * Fri Mar 02 2018 - Ruan G. Ellis <ruan.ellis@alces-software.com>
    - Bumped to v1.6.0 version
:src: v1.6.0.tar.gz 
:version: '1.6.0'
:src_dir: tensorflow-1.6.0 
:compilers:
  gcc:
:requirements:
  :tool:
    - apps/bazel >= 0.5.4
  :build:
    - apps/python
    - libs/numpy
    - apps/setuptools
    - apps/pip
    - libs/nvidia-cuda
    - mpi/openmpi
  :runtime:
    - apps/python
    - apps/setuptools
    - libs/numpy
    - libs/nvidia-cuda
    - mpi/openmpi
:compile: |
  export LD_LIBRARY_PATH=/opt/apps/alces/nvidia/cudnn/7.0.5_cuda8.0/lib64:$LD_LIBRARY_PATH
  export LD_LIBRARY_PATH=${CUDA_HOME}/extras/CUPTI/lib64/:${LD_LIBRARY_PATH}
  export GCC_HOST_COMPILER_PATH=`which gcc`
  export TF_NEED_HDFS=0
  export TF_NEED_OPENCL=0
  export TF_NEED_JEMALLOC=0
  export TF_NEED_CUDA=1
  export CUDA_TOOLKIT_PATH=${CUDA_HOME}
  export TF_CUDA_VERSION=8.0.61
  export TF_CUDA_COMPUTE_CAPABILITIES="6.0"
  export CUDNN_INSTALL_PATH=/opt/apps/alces/nvidia/cudnn/7.0.5_cuda8.0
  export TF_CUDNN_VERSION=7.0.5
  export CC_OPT_FLAGS=-march=native
  export TF_NEED_GCP=0
  export TF_ENABLE_XLA=0
  export TF_NEED_MPI=1
  export PYTHON_BIN_PATH=${PYTHONBIN}/python
  export PYTHON_LIB_PATH=<%= dest_dir %>/python
  mkdir -p $PYTHON_LIB_PATH/lib/python2.7/site-packages
  export PYTHONPATH=$PYTHONPATH:<%= dest_dir %>/python/lib/python2.7/site-packages

  echo "startup --batch" >> .bazelrc
  ./configure <%= redirect(:configure) %>
  easy_install --prefix=${PYTHON_LIB_PATH} nose wheel <%= redirect(:python) %>
  bazel build --config=opt //tensorflow/tools/pip_package:build_pip_package --verbose_failures <%= redirect(:bazel_build) %>
  git clone https://github.com/tensorflow/tensorboard.git && cd tensorboard && git checkout 1.6.0 <%= redirect(:bazel_tensorboard_build) %>
  #bazel build tensorboard:tensorboard <%= redirect(:bazel_tensorboard_build) %>
  cd ..
  ./tensorflow/tools/pip_package/build_pip_package.sh <%= dest_dir %>/wheel/. <%= redirect(:pip_build) %>
:install: |
  PYTHONDEPSDIR=$(pwd)/python/lib/python2.7/site-packages
  export PYTHONPATH=$PYTHONPATH:$PYTHONDEPSDIR
  pwd <%= redirect(:installdir) %>
  mkdir -p <%= dest_dir %>/doc
  cp -Rv tensorflow/docs_src/* <%= dest_dir %>/doc/. <%= redirect(:install_tensorboard) %>
  pip install <%= dest_dir %>/wheel/tensorflow-1.6.0-cp27-cp27m-linux_x86_64.whl --prefix=<%= dest_dir %>/python <%= redirect(:install) %>
:module: |
  setenv ${appcaps}DIR ${appdir}
  setenv ${appcaps}PYTHON ${appdir}/python
  setenv ${appcaps}SHARE ${appdir}/share
  setenv ${appcaps}DOC ${appdir}/doc

  prepend-path PYTHONPATH ${appdir}/python/lib/python2.7/site-packages
